<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EWCMUN - Logging System</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    /* ALL YOUR EXISTING CSS STAYS EXACTLY THE SAME */
    :root{
      --card-bg:#ffffff;
      --muted:#666;
      --accent:#018B85;
      --bg-color:#f3f6fb;
      --text-color:#111;
      --header-bg:linear-gradient(90deg,#018B85,#0f172a);
      --header-color:white;
      --input-bg:#fff;
      --input-border:#d1d5db;
      --footer-color:#666;
    }

    [data-theme="dark"] {
      --card-bg:#1e293b;
      --muted:#94a3b8;
      --accent:#0d9488;
      --bg-color:#0f172a;
      --text-color:#e2e8f0;
      --header-bg:linear-gradient(90deg,#0f766e,#1e293b);
      --header-color:#e2e8f0;
      --input-bg:#334155;
      --input-border:#475569;
      --footer-color:#94a3b8;
    }

    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      margin:0;
      background:var(--bg-color);
      color:var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    header{
      background:var(--header-bg);
      color:var(--header-color);
      padding:12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .theme-toggle {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      width: auto;
      transition: all 0.3s;
    }
    .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
      transform: none;
      box-shadow: none;
    }
    .container{
      display:grid;
      grid-template-columns:360px 1fr 320px;
      gap:12px;
      padding:14px;
    }
    .card{
      background:var(--card-bg);
      padding:12px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
      transition: background-color 0.3s;
    }
    h2{
      margin:0 0 8px;
      font-size:16px;
      color:var(--accent);
    }
    label{
      display:block;
      font-size:13px;
      color:var(--muted);
    }
    input,select,textarea,button{
      width:100%;
      padding:8px;
      margin-top:6px;
      margin-bottom:8px;
      border-radius:6px;
      border:1px solid var(--input-border);
      font-family:inherit;
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: background-color 0.3s, border-color 0.3s, color 0.3s;
    }
    button{
      background:var(--accent);
      color:#fff;
      border:none;
      cursor:pointer;
      transition:all .25s ease;
      box-shadow:0 4px 10px rgba(1,139,133,0.4);
    }
    button:hover{
      background:#026c68;
      box-shadow:0 0 15px rgba(1,139,133,0.7);
      transform:translateY(-1px) scale(1.03);
    }
    .small{font-size:13px}
    .list{max-height:300px;overflow:auto}
    .speaker{display:flex;justify-content:space-between;padding:6px;border-bottom:1px dashed var(--muted)}
    .actions{display:flex;gap:6px}
    .timer-display{font-weight:700;font-size:28px;text-align:center;padding:8px;color:var(--accent)}
    .motions{display:flex;flex-direction:column;gap:8px}
    footer{
      padding:12px;
      text-align:center;
      color:var(--footer-color);
    }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .nav-tab {
      padding: 8px 16px;
      background: var(--card-bg);
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--input-border);
      transition: all 0.3s;
    }
    .nav-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    
    .grading-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    .grading-table th, .grading-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--input-border);
      text-align: center;
    }
    .grading-table th {
      background: var(--input-bg);
      font-weight: 600;
      font-size: 12px;
    }
    .grading-table input[type="number"] {
      width: 50px;
      margin: 0;
      padding: 4px;
    }
    .grading-table input[type="text"] {
      width: 120px;
      margin: 0;
      padding: 6px;
    }
    .grading-table .delegate-country {
      font-weight: 600;
      text-align: left;
    }
    .grading-table .total {
      font-weight: bold;
    }
    .grading-table .award {
      font-weight: 700;
    }
    .grading-controls {
      margin: 10px 0 18px;
      display: flex;
      gap: 8px;
    }
    .grading-controls button {
      width: auto;
      padding: 8px 12px;
    }
    .weights-info {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    
    /* Committee Selection Styles */
    .committee-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      min-height: 60vh;
    }
    .committee-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 1000px;
      margin-top: 30px;
    }
    .committee-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(16,24,40,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .committee-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(16,24,40,0.15);
      border-color: var(--accent);
    }
    .committee-card h2 {
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 20px;
    }
    .committee-card p {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }
    .committee-code {
      background: var(--input-bg);
      padding: 8px 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      margin: 15px 0;
      border: 1px solid var(--input-border);
    }

    /* Firebase Status */
    .firebase-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
    }
    .firebase-connected {
      background: #10b981;
      color: white;
    }
    .firebase-disconnected {
      background: #ef4444;
      color: white;
    }
    
    /* Motion History Reset Button */
    .motion-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Delegate Name Input */
    .delegate-name-input {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    /* Speakers History Styles */
    .speakers-history-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    .speakers-history-table th, .speakers-history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--input-border);
      text-align: left;
    }
    .speakers-history-table th {
      background: var(--input-bg);
      font-weight: 600;
      font-size: 13px;
    }
    .speakers-history-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    .speakers-history-controls button {
      width: auto;
      padding: 8px 12px;
    }
    .speakers-history-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }
    .speakers-history-stat-card {
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(16,24,40,0.05);
    }
    .speakers-history-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 5px;
    }
    .speakers-history-stat-label {
      font-size: 13px;
      color: var(--muted);
    }
    
    @media (max-width:1000px){
      .container{grid-template-columns:1fr;}
      .committee-cards {grid-template-columns: 1fr;}
      .speakers-history-stats {grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <!-- Firebase Connection Status -->
  <div id="firebase-status" class="firebase-status firebase-disconnected">Firebase: Disconnected</div>

  <header>
    <div>
      <strong>EWCMUN ‚Äî Logging System</strong>
      <div style="font-size:13px;opacity:.9" id="committee-display">Select a Committee</div>
    </div>
    <button class="theme-toggle" id="theme-toggle">üåô Dark Mode</button>
  </header>

  <!-- Committee Selection Page -->
  <div id="committee-selection-page" class="page active">
    <div class="committee-selection">
      <h1 style="text-align:center;margin-bottom:10px;">Select Your Committee</h1>
      <p style="text-align:center;color:var(--muted);max-width:600px;margin-bottom:30px;">
        Choose your committee to access the MUN logging system. Each committee has its own dedicated workspace.
      </p>
      
      <div class="committee-cards">
        <div class="committee-card" data-committee="unhrc">
          <h2>UNHRC</h2>
          <p>United Nations Human Rights Council</p>
          <div class="committee-code">Code: UNHRC2025</div>
          <button>Enter Committee</button>
        </div>
        
        <div class="committee-card" data-committee="unga">
          <h2>UNGA</h2>
          <p>United Nations General Assembly</p>
          <div class="committee-code">Code: UNGA2025</div>
          <button>Enter Committee</button>
        </div>
        
        <div class="committee-card" data-committee="icc">
          <h2>ICC</h2>
          <p>International Criminal Court</p>
          <div class="committee-code">Code: ICC2025</div>
          <button>Enter Committee</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Committee Workspace -->
  <div id="committee-workspace" class="page">
    <div style="padding: 14px 14px 0 14px;">
      <div class="nav-tabs">
        <div class="nav-tab active" data-page="main">Main Control</div>
        <div class="nav-tab" data-page="grading">Delegate Grading</div>
        <div class="nav-tab" data-page="speakers-history">Speakers History</div>
        <button id="back-to-committees" style="margin-left:auto;width:auto;">‚Üê Back to Committees</button>
      </div>
    </div>

    <!-- Main Control Page -->
    <div id="main-page" class="page active">
      <div class="container">
        <!-- Left column: Roll call + Speaker list -->
        <div>
          <div class="card">
            <h2>Roll Call</h2>
            <label>Country name</label>
            <div style="display:flex;gap:8px">
              <input id="rc-name" placeholder="e.g. Lebanon">
              <button id="rc-add">Add</button>
            </div>
            <div class="list" id="rc-list" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="rc-mark-present">Mark Present</button>
              <button id="rc-mark-pv">Present & Voting</button>
              <button id="rc-add-to-speakers">Add to Speakers</button>
              <button id="rc-clear">Clear</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h2>Speaker's List</h2>
            <label>Delegate / Country</label>
            <div style="display:flex;gap:8px">
              <input id="sp-name" placeholder="Add to speaker list">
              <button id="sp-add">Add</button>
            </div>
            <label>Default speaking time (sec)</label>
            <input id="sp-default" type="number" value="60">
            <div class="list" id="sp-list"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="sp-next">Next Speaker</button>
              <button id="sp-remove">Remove Selected</button>
              <button id="sp-clear">Clear</button>
            </div>
          </div>
        </div>

        <!-- Middle: Timer, motions -->
        <div>
          <div class="card">
            <h2>Timer / Chair Controls</h2>
            <div style="display:flex;gap:10px">
              <div style="flex:1">
                <label>Current Timer</label>
                <div class="timer-display" id="timer">00:00</div>
                <div style="display:flex;gap:8px">
                  <input id="timer-mins" type="number" placeholder="mins" value="1">
                  <input id="timer-secs" type="number" placeholder="secs" value="0">
                  <button id="timer-start">Start</button>
                  <button id="timer-stop">Stop</button>
                  <button id="timer-reset">Reset</button>
                </div>
              </div>
            </div>

            <hr>

            <h2>Motions</h2>
            <div class="motions">
              <select id="motion-type">
                <option>Moderated Caucus</option>
                <option>Unmoderated Caucus</option>
                <option>Open/Close Speaker's List</option>
                <option>Suspend Debate</option>
                <option>Resume Debate</option>
                <option>Extension of Caucus</option>
                <option>Suspend Meeting</option>
                <option>Adjourn Meeting</option>
              </select>
              <div style="display:flex;gap:8px">
                <input id="motion-duration" placeholder="Duration (mins)" type="number">
                <input id="motion-speak" placeholder="Speaking time (secs)" type="number">
                <button id="motion-propose">Propose Motion</button>
              </div>
              <div class="motion-controls">
                <button id="motion-reset">Reset Motion History</button>
              </div>
              <div id="motion-log" style="max-height:160px;overflow:auto;margin-top:8px;background:var(--input-bg);padding:8px;border-radius:6px;border:1px solid var(--input-border)"></div>
            </div>

            <hr>

            <h2>Voting Bloc Simulator</h2>
            <label>Begin Voting</label>
            <div style="display:flex;gap:8px">
              <button id="voting-start">Begin Voting</button>
              <button id="voting-result">Show Result</button>
            </div>
            <div id="voting-log" style="margin-top:8px;padding:8px;background:var(--input-bg);border-radius:6px;border:1px solid var(--input-border)"></div>
          </div>
        </div>

        <!-- Right column: Quick settings -->
        <div>
          <div class="card">
            <h2>Quick Settings</h2>
            <label>Chair name</label>
            <input id="chair-name" placeholder="e.g. Maria">
            <label>Conference</label>
            <input id="conf-name" placeholder="Conference name">
            <label>Auto-save</label>
            <select id="autosave"><option value="1">On</option><option value="0">Off</option></select>
            <button id="save-all">Save Now</button>
            <button id="load-all">Load Saved</button>
          </div>
          
          <div class="card" style="margin-top:12px">
            <h2>Quick Grading</h2>
            <p style="font-size:13px;color:var(--muted);margin:0 0 8px 0">
              For detailed grading, go to the Grading page
            </p>
            <button id="go-to-grading">Go to Grading Page</button>
            <button id="sync-delegates" style="margin-top:8px">Add Delegates from Roll Call</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Grading Page -->
    <div id="grading-page" class="page">
      <div class="container" style="grid-template-columns: 1fr;">
        <div>
          <div class="card">
            <h2>MUN Grading Sheet</h2>
            <div class="weights-info">
            </div>
            
            <div class="grading-controls">
              <button id="addDelegates">Add Delegates</button>
              <button id="clearAll">Clear All</button>
              <button id="exportCsv">Export CSV</button>
              <div style="margin-left:auto" class="small">Scores: 1 (None) ‚Äî 5 (Excellent)</div>
            </div>
            
            <table class="grading-table" id="sheet">
              <thead>
                <tr>
                  <th>Country</th>
                  <th>Delegate Name</th>
                  <th>Research<br/>(20%)</th>
                  <th>Participation<br/>(25%)</th>
                  <th>Diplomacy<br/>(20%)</th>
                  <th>Speech<br/>(15%)</th>
                  <th>Writing<br/>(10%)</th>
                  <th>Leadership<br/>(10%)</th>
                  <th>Total %</th>
                  <th>Award</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="grading-tbody">
                <!-- rows added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Speakers History Page -->
    <div id="speakers-history-page" class="page">
      <div class="container" style="grid-template-columns: 1fr;">
        <div>
          <div class="card">
            <h2>Speakers History</h2>
            <p style="font-size:13px;color:var(--muted);margin:0 0 15px 0">
              Track all delegates who have spoken during the committee session, including speaking order and statistics.
            </p>
            
            <div class="speakers-history-controls">
              <button id="add-to-history">Add Current Speaker</button>
              <button id="clear-history">Clear History</button>
              <button id="export-speakers-csv">Export CSV</button>
            </div>
            
            <div class="speakers-history-stats">
              <div class="speakers-history-stat-card">
                <div class="speakers-history-stat-value" id="total-speakers">0</div>
                <div class="speakers-history-stat-label">Total Speakers</div>
              </div>
              <div class="speakers-history-stat-card">
                <div class="speakers-history-stat-value" id="unique-speakers">0</div>
                <div class="speakers-history-stat-label">Unique Speakers</div>
              </div>
              <div class="speakers-history-stat-card">
                <div class="speakers-history-stat-value" id="most-frequent">-</div>
                <div class="speakers-history-stat-label">Most Frequent Speaker</div>
              </div>
            </div>
            
            <table class="speakers-history-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Delegate/Country</th>
                  <th>Speaking Order</th>
                  <th>Times Spoken</th>
                  <th>Last Spoken</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="speakers-history-list">
                <!-- rows added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>¬© EWCMUN2025</footer>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyAM_5HMroAMNS-CfZ4XzzRqo26wBkbFhoA",
      authDomain: "ewcmun-setup.firebaseapp.com",
      projectId: "ewcmun-setup",
      storageBucket: "ewcmun-setup.firebasestorage.app",
      messagingSenderId: "299967110413",
      appId: "1:299967110413:web:61af02f6f10868ff342444"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Firebase connection status
    const firebaseStatus = document.getElementById('firebase-status');
    
    firebase.firestore().enablePersistence()
      .then(() => {
        firebaseStatus.textContent = 'Firebase: Connected';
        firebaseStatus.className = 'firebase-status firebase-connected';
      })
      .catch((err) => {
        console.log('Firebase persistence failed: ', err);
        firebaseStatus.textContent = 'Firebase: Connected (Offline Mode)';
        firebaseStatus.className = 'firebase-status firebase-connected';
      });

    // ==================== COMMITTEE MANAGEMENT ====================
    let currentCommittee = null;
    let unsubscribeFirestore = null;

    const committees = {
      'unhrc': {
        name: 'UN Human Rights Council',
        code: 'UNHRC2024',
        data: {
          rollcall: [],
          speakers: [],
          currentSpeaker: null,
          timer: {remaining:0, interval:null},
          motions: [],
          voting: {active:false, votes:[]},
          grades: {},
          settings: {chairName: '', conference: ''},
          speakersHistory: []
        }
      },
      'unga': {
        name: 'UN General Assembly',
        code: 'UNGA2024',
        data: {
          rollcall: [],
          speakers: [],
          currentSpeaker: null,
          timer: {remaining:0, interval:null},
          motions: [],
          voting: {active:false, votes:[]},
          grades: {},
          settings: {chairName: '', conference: ''},
          speakersHistory: []
        }
      },
      'icc': {
        name: 'International Criminal Court',
        code: 'ICC2024',
        data: {
          rollcall: [],
          speakers: [],
          currentSpeaker: null,
          timer: {remaining:0, interval:null},
          motions: [],
          voting: {active:false, votes:[]},
          grades: {},
          settings: {chairName: '', conference: ''},
          speakersHistory: []
        }
      }
    };

    // Get current committee data
    function getCurrentCommitteeData() {
      return committees[currentCommittee]?.data;
    }

    // Committee Selection
    document.querySelectorAll('.committee-card').forEach(card => {
      card.addEventListener('click', () => {
        const committeeId = card.getAttribute('data-committee');
        enterCommittee(committeeId);
      });
    });

    function enterCommittee(committeeId) {
      currentCommittee = committeeId;
      document.getElementById('committee-selection-page').classList.remove('active');
      document.getElementById('committee-workspace').classList.add('active');
      document.getElementById('committee-display').textContent = committees[committeeId].name;
      
      // Set up real-time Firestore listener
      setupFirestoreListener();
      
      // Load committee data
      loadCommitteeData();
      renderAll();
      renderGradingTable();
      renderSpeakersHistory();
    }

    // Set up Firestore real-time listener
    function setupFirestoreListener() {
      if (unsubscribeFirestore) {
        unsubscribeFirestore(); // Clean up previous listener
      }

      unsubscribeFirestore = db.collection('committees').doc(currentCommittee)
        .onSnapshot((doc) => {
          if (doc.exists) {
            const firestoreData = doc.data();
            Object.assign(getCurrentCommitteeData(), firestoreData);
            renderAll();
            updateUIFromData();
          }
        }, (error) => {
          console.error('Firestore listener error:', error);
        });
    }

    // Save data to Firestore
    function saveToFirestore() {
      if (!currentCommittee) return;
      
      // Update grading data from current table
      const state = getCurrentCommitteeData();
      state.grades = {};
      
      const tbody = document.querySelector('#grading-tbody');
      tbody.querySelectorAll('tr').forEach(tr => {
        const country = tr.querySelector('.delegate-country').textContent;
        const delegateName = tr.querySelector('.delegate-name-input').value || '';
        const grades = {
          delegateName: delegateName,
          research: parseInt(tr.querySelector('input[data-key="research"]').value) || 3,
          participation: parseInt(tr.querySelector('input[data-key="participation"]').value) || 3,
          diplomacy: parseInt(tr.querySelector('input[data-key="diplomacy"]').value) || 3,
          speech: parseInt(tr.querySelector('input[data-key="speech"]').value) || 3,
          writing: parseInt(tr.querySelector('input[data-key="writing"]').value) || 3,
          leadership: parseInt(tr.querySelector('input[data-key="leadership"]').value) || 3
        };
        state.grades[country] = grades;
      });
      
      // Save to Firestore
      db.collection('committees').doc(currentCommittee).set(state, { merge: true })
        .then(() => {
          console.log('Data saved to Firestore');
        })
        .catch((error) => {
          console.error('Error saving to Firestore:', error);
        });
    }

    // Load data from Firestore (initial load)
    function loadCommitteeData() {
      if (!currentCommittee) return;
      
      db.collection('committees').doc(currentCommittee).get()
        .then((doc) => {
          if (doc.exists) {
            Object.assign(getCurrentCommitteeData(), doc.data());
            updateUIFromData();
          }
        })
        .catch((error) => {
          console.error('Error loading from Firestore:', error);
        });
    }

    // Update UI from loaded data
    function updateUIFromData() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      // Update settings fields
      el('chair-name').value = state.settings?.chairName || '';
      el('conf-name').value = state.settings?.conference || '';
    }

    // Back to committees
    document.getElementById('back-to-committees').addEventListener('click', () => {
      if (unsubscribeFirestore) {
        unsubscribeFirestore();
        unsubscribeFirestore = null;
      }
      
      document.getElementById('committee-workspace').classList.remove('active');
      document.getElementById('committee-selection-page').classList.add('active');
      document.getElementById('committee-display').textContent = 'Select a Committee';
      currentCommittee = null;
    });

    // ==================== SPEAKERS HISTORY FEATURE ====================
    
    // Render speakers history table
    function renderSpeakersHistory() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const tbody = document.getElementById('speakers-history-list');
      tbody.innerHTML = '';
      
      // Update statistics
      const totalSpeakers = state.speakersHistory.length;
      const uniqueSpeakers = [...new Set(state.speakersHistory.map(item => item.name))].length;
      
      // Calculate most frequent speaker
      const frequency = {};
      state.speakersHistory.forEach(item => {
        frequency[item.name] = (frequency[item.name] || 0) + 1;
      });
      
      let mostFrequent = '-';
      let maxCount = 0;
      Object.keys(frequency).forEach(name => {
        if (frequency[name] > maxCount) {
          maxCount = frequency[name];
          mostFrequent = name;
        }
      });
      
      // Update statistics display
      document.getElementById('total-speakers').textContent = totalSpeakers;
      document.getElementById('unique-speakers').textContent = uniqueSpeakers;
      document.getElementById('most-frequent').textContent = mostFrequent;
      
      // Render table rows
      state.speakersHistory.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.name}</td>
          <td>${item.order}</td>
          <td>${frequency[item.name] || 1}</td>
          <td>${item.timestamp || 'N/A'}</td>
          <td><button class="remove-speaker-history" data-index="${index}">Remove</button></td>
        `;
        tbody.appendChild(tr);
      });
      
      // Attach event listeners to remove buttons
      document.querySelectorAll('.remove-speaker-history').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          removeSpeakerFromHistory(index);
        });
      });
    }
    
    // Add current speaker to history
    function addCurrentSpeakerToHistory() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      if (!state.currentSpeaker) {
        alert('No current speaker. Use "Next Speaker" button first.');
        return;
      }
      
      const speakerName = state.currentSpeaker;
      const timestamp = new Date().toLocaleTimeString();
      const order = state.speakersHistory.length + 1;
      
      state.speakersHistory.push({
        name: speakerName,
        order: order,
        timestamp: timestamp
      });
      
      renderSpeakersHistory();
      saveToFirestore();
      
      // Clear current speaker after adding to history
      state.currentSpeaker = null;
    }
    
    // Remove speaker from history
    function removeSpeakerFromHistory(index) {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      state.speakersHistory.splice(index, 1);
      renderSpeakersHistory();
      saveToFirestore();
    }
    
    // Clear all speakers history
    function clearSpeakersHistory() {
      if (confirm('Are you sure you want to clear all speakers history? This cannot be undone.')) {
        const state = getCurrentCommitteeData();
        if (!state) return;
        
        state.speakersHistory = [];
        renderSpeakersHistory();
        saveToFirestore();
      }
    }
    
    // Export speakers history to CSV
    function exportSpeakersHistoryToCSV() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      if (state.speakersHistory.length === 0) {
        alert('No speakers history to export.');
        return;
      }
      
      const headers = ['Order', 'Delegate/Country', 'Timestamp'];
      const rows = state.speakersHistory.map(item => [
        item.order,
        item.name,
        item.timestamp || 'N/A'
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(field => `"${field}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentCommittee}_speakers_history.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // ==================== REST OF YOUR EXISTING CODE ====================
    // (All your existing functionality remains the same)

    // Timer sound
    const timerSound = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
    
    function playTimerSound() {
      try {
        timerSound.play();
      } catch (e) {
        console.log("\u0007");
      }
    }

    // Utility functions
    function el(id){return document.getElementById(id)}
    
    function renderRoll(){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const cont=el('rc-list'); cont.innerHTML='';
      state.rollcall.forEach((r,i)=>{
        const div=document.createElement('div'); 
        div.style.display='flex'; div.style.justifyContent='space-between';
        div.style.padding='6px'; div.style.borderBottom='1px solid var(--muted)';
        div.innerHTML=`<div><strong>${r.name}</strong><div style="font-size:12px;color:var(--muted)">${r.status||'Not marked'}</div></div>`;
        const btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px';
        const sel=document.createElement('button'); sel.textContent='Select'; sel.onclick=()=>{state.rollcall[i].selected=!state.rollcall[i].selected; renderRoll(); saveToFirestore();}
        btns.appendChild(sel);
        div.appendChild(btns);
        if(r.selected) {
          div.style.background='var(--accent)'; 
          div.style.color='white';
        }
        cont.appendChild(div);
      })
    }

    function renderSpeakers(){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const cont=el('sp-list'); cont.innerHTML='';
      state.speakers.forEach((s,i)=>{
        const div=document.createElement('div'); div.className='speaker';
        div.innerHTML=`<div><strong>${s}</strong></div><div class="actions"><button onclick="removeSpeaker(${i})">Remove</button></div>`;
        cont.appendChild(div);
      })
    }
    window.removeSpeaker=(i)=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      state.speakers.splice(i,1);
      renderSpeakers();
      saveToFirestore();
    }

    // Roll Call
    el('rc-add').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const name=el('rc-name').value.trim();
      if(!name)return;
      state.rollcall.push({name,status:'Not marked'});
      el('rc-name').value='';
      renderRoll();
      saveToFirestore();
    }
    el('rc-mark-present').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      state.rollcall.forEach(r=>{if(r.selected)r.status='Present';r.selected=false});
      renderRoll();
      saveToFirestore();
    }
    el('rc-mark-pv').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      state.rollcall.forEach(r=>{if(r.selected)r.status='Present & Voting';r.selected=false});
      renderRoll();
      saveToFirestore();
    }
    // NEW: Add selected delegates to speakers list
    el('rc-add-to-speakers').onclick = () => {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const selectedDelegates = state.rollcall.filter(r => r.selected);
      
      if (selectedDelegates.length === 0) {
        alert('Please select delegates first by clicking "Select" next to their names');
        return;
      }
      
      selectedDelegates.forEach(delegate => {
        // Check if delegate is already in speakers list to avoid duplicates
        if (!state.speakers.includes(delegate.name)) {
          state.speakers.push(delegate.name);
        }
        // Clear selection after adding
        delegate.selected = false;
      });
      
      renderRoll();
      renderSpeakers();
      saveToFirestore();
      
      alert(`Added ${selectedDelegates.length} delegate${selectedDelegates.length !== 1 ? 's' : ''} to speakers list`);
    }
    el('rc-clear').onclick=()=>{
      if(confirm('Clear all roll call?')){
        const state = getCurrentCommitteeData();
        if (!state) return;
        
        state.rollcall=[];
        renderRoll();
        saveToFirestore();
      }
    }

    // Speakers
    el('sp-add').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const v=el('sp-name').value.trim();
      if(!v)return;
      state.speakers.push(v);
      el('sp-name').value='';
      renderSpeakers();
      saveToFirestore();
    }
    el('sp-clear').onclick=()=>{
      if(confirm('Clear speaker list?')){
        const state = getCurrentCommitteeData();
        if (!state) return;
        
        state.speakers=[];
        renderSpeakers();
        saveToFirestore();
      }
    }
    el('sp-next').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      if(state.speakers.length===0){alert('No speakers');return;}
      const s=state.speakers.shift();
      renderSpeakers();
      startSpeakerTimer(s);
      saveToFirestore();
      
      // NEW: Automatically add to history and switch to Speakers History page
      addSpeakerToHistory(s);
      navigateToSpeakersHistory();
    }
    
    // NEW: Add speaker to history
    function addSpeakerToHistory(speakerName) {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const order = state.speakersHistory.length + 1;
      
      state.speakersHistory.push({
        name: speakerName,
        order: order,
        timestamp: timestamp
      });
      
      renderSpeakersHistory();
      saveToFirestore();
    }
    
    // NEW: Navigate to Speakers History page
    function navigateToSpeakersHistory() {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.nav-tab[data-page="speakers-history"]').classList.add('active');
      
      document.querySelectorAll('#committee-workspace .page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById('speakers-history-page').classList.add('active');
    }
    
    function startSpeakerTimer(name){
      const secs=Number(el('sp-default').value)||60;
      startTimer(secs);
      
      const state = getCurrentCommitteeData();
      if (state) {
        state.currentSpeaker=name;
      }
      alert(`Now speaking: ${name}`);
    }

    // Timer
    function formatTime(s){const m=Math.floor(s/60);const sec=s%60;return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`}
    function renderTimer(){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      el('timer').textContent=formatTime(state.timer.remaining)
    }
    function startTimer(seconds){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      stopTimer();
      state.timer.remaining=seconds;
      renderTimer();
      state.timer.interval=setInterval(()=>{
        state.timer.remaining--;
        renderTimer();
        if(state.timer.remaining<=0){
          stopTimer();
          playTimerSound();
          alert('Time is up!');
        }
      },1000);
      saveToFirestore();
    }
    function stopTimer(){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      if(state.timer.interval)clearInterval(state.timer.interval);
      state.timer.interval=null;
      saveToFirestore();
    }
    el('timer-start').onclick=()=>{
      const m=Number(el('timer-mins').value||0);
      const s=Number(el('timer-secs').value||0);
      startTimer(m*60+s);
    }
    el('timer-stop').onclick=()=>{stopTimer();}
    el('timer-reset').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      stopTimer();
      state.timer.remaining=0;
      renderTimer();
      saveToFirestore();
    }

    // Motions
    el('motion-propose').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const type=el('motion-type').value;
      const dur=Number(el('motion-duration').value)||0;
      const sp=Number(el('motion-speak').value)||0;
      const motion={type,duration:dur,speaking:sp,time:new Date().toLocaleTimeString()};
      state.motions.push(motion);
      renderMotions();
      
      // Only start timer for moderated and unmoderated caucuses
      if ((type === 'Moderated Caucus' || type === 'Unmoderated Caucus') && dur > 0) {
        const totalSeconds = dur * 60;
        startTimer(totalSeconds);
        alert(`Timer started for ${dur} minute${dur !== 1 ? 's' : ''} ${type}`);
      }
      saveToFirestore();
    }
    
    // Reset motion history
    el('motion-reset').onclick=()=>{
      if(confirm('Clear all motion history?')){
        const state = getCurrentCommitteeData();
        if (!state) return;
        
        state.motions=[];
        renderMotions();
        saveToFirestore();
      }
    }
    
    function renderMotions(){
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      const node=el('motion-log');node.innerHTML='';
      state.motions.slice().reverse().forEach(m=>{
        const d=document.createElement('div');
        d.style.borderBottom='1px solid var(--muted)';
        d.style.padding='6px';
        d.innerHTML=`<strong>${m.type}</strong> ‚Äî ${m.duration||'-'} min ‚Äî ${m.speaking||0}s ‚Äî <span style="font-size:12px;color:var(--muted)">proposed ${m.time}</span>`;
        node.appendChild(d);
      })
    }

    // Voting
    el('voting-start').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      if(state.voting.active){alert('Voting already active');return}
      state.voting.active=true;
      state.voting.votes=[];
      el('voting-log').innerHTML='Voting started ‚Äî click names to cast votes.';
      const cont=document.createElement('div');
      state.rollcall.forEach((r,idx)=>{
        const b=document.createElement('button');b.textContent=r.name;b.style.margin='4px';b.onclick=(()=>{return function(){castVote(idx)}})();cont.appendChild(b);
      });
      el('voting-log').appendChild(cont);
      saveToFirestore();
    }
    function castVote(idx){
      const state = getCurrentCommitteeData();
      if (!state || !state.voting.active) return;
      
      const choice=prompt(`Vote for ${state.rollcall[idx].name} (Y/N/A for abstain)`);
      if(!choice)return;
      state.voting.votes.push({country:state.rollcall[idx].name,vote:choice.toUpperCase()});
      el('voting-log').innerHTML=`Cast ${state.voting.votes.length} votes.`;
      saveToFirestore();
    }
    el('voting-result').onclick=()=>{
      const state = getCurrentCommitteeData();
      if (!state || !state.voting.active) return alert('Start voting first');
      
      state.voting.active=false;
      const tally={Y:0,N:0,A:0};
      state.voting.votes.forEach(v=>{tally[v.vote[0]]=(tally[v.vote[0]]||0)+1});
      el('voting-log').innerHTML=`Results ‚Äî For: ${tally.Y||0} Against: ${tally.N||0} Abstain: ${tally.A||0}`;
      saveToFirestore();
    }

    // ==================== FIXED GRADING SYSTEM ====================
    const weights = { research:20, participation:25, diplomacy:20, speech:15, writing:10, leadership:10 };
    const gradingTbody = document.getElementById('grading-tbody');
    const addDelegatesBtn = document.getElementById('addDelegates');
    const clearBtn = document.getElementById('clearAll');
    const exportBtn = document.getElementById('exportCsv');
    const syncDelegatesBtn = document.getElementById('sync-delegates');

    function delegateExists(country) {
      const existingCountries = Array.from(gradingTbody.querySelectorAll('.delegate-country')).map(td => td.textContent.trim());
      return existingCountries.includes(country.trim());
    }

    function newRow(country='', delegateName=''){
      if (country && delegateExists(country)) {
        return;
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="delegate-country">${country || 'New Country'}</td>
        <td><input type="text" class="delegate-name-input" value="${delegateName || ''}" placeholder="Delegate name" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="research" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="participation" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="diplomacy" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="speech" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="writing" /></td>
        <td><input type="number" min="1" max="10" value="0" data-key="leadership" /></td>
        <td class="total">0</td>
        <td class="award">-</td>
        <td><button class="remove">Remove</button></td>
      `;

      gradingTbody.appendChild(tr);
      attachListeners(tr);
      calculateRow(tr);
      saveToFirestore();
    }

    function attachListeners(tr){
      tr.querySelectorAll('input[type=number]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          calculateRow(tr);
          saveToFirestore();
        });
      });
      
      // Save delegate name when changed - FIXED: Only save on blur, not every keystroke
      const nameInput = tr.querySelector('.delegate-name-input');
      nameInput.addEventListener('blur', () => {
        saveToFirestore();
      });
      
      tr.querySelector('.remove').addEventListener('click', ()=>{ 
        tr.remove(); 
        saveToFirestore();
      });
    }

    function calculateRow(tr){
      const inputs = tr.querySelectorAll('input[type=number]');
      let percent = 0;
      inputs.forEach(i=>{
        const key = i.dataset.key;
        const score = Number(i.value) || 0;
        const w = weights[key] || 0;
        percent += (score/5) * w;
      });
      const totalCell = tr.querySelector('.total');
      totalCell.textContent = percent.toFixed(1) + '%';
      const awardCell = tr.querySelector('.award');
      awardCell.textContent = awardFromPercent(percent);
    }

    function awardFromPercent(p){
      if(p>=90) return 'Best Delegate';
      if(p>=80) return 'Outstanding Delegate';
      if(p>=70) return 'Honourable Mention';
      if(p>=60) return 'Verbal Commendation';
      return 'Participant';
    }

    function syncRollCallToGrading() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      let addedCount = 0;
      
      // Clear existing grading table
      gradingTbody.innerHTML = '';
      
      // Add ALL delegates from roll call in the exact same order
      state.rollcall.forEach(delegate => {
        newRow(delegate.name);
        addedCount++;
      });
      
      if (addedCount > 0) {
        alert(`Added ${addedCount} delegate${addedCount !== 1 ? 's' : ''} from roll call to grading sheet`);
      } else {
        alert('No delegates in roll call to add');
      }
    }

    function renderGradingTable() {
      const state = getCurrentCommitteeData();
      if (!state) return;
      
      gradingTbody.innerHTML = '';
      
      // Render delegates in the EXACT SAME ORDER as roll call
      if (state.rollcall && state.rollcall.length > 0) {
        state.rollcall.forEach(delegate => {
          const country = delegate.name;
          const gradeData = state.grades[country] || {};
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="delegate-country">${country}</td>
            <td><input type="text" class="delegate-name-input" value="${gradeData.delegateName || ''}" placeholder="Delegate name" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.research || 3}" data-key="research" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.participation || 3}" data-key="participation" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.diplomacy || 3}" data-key="diplomacy" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.speech || 3}" data-key="speech" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.writing || 3}" data-key="writing" /></td>
            <td><input type="number" min="1" max="5" value="${gradeData.leadership || 3}" data-key="leadership" /></td>
            <td class="total">0</td>
            <td class="award">-</td>
            <td><button class="remove">Remove</button></td>
          `;
          gradingTbody.appendChild(tr);
          attachListeners(tr);
          calculateRow(tr);
        });
      }
    }

    addDelegatesBtn.addEventListener('click', syncRollCallToGrading);
    clearBtn.addEventListener('click', ()=>{ 
      if (confirm('Clear all grading data?')) {
        gradingTbody.innerHTML=''; 
        const state = getCurrentCommitteeData();
        if (state) state.grades = {};
        saveToFirestore();
      }
    });
    
    syncDelegatesBtn.addEventListener('click', syncRollCallToGrading);

    exportBtn.addEventListener('click', ()=>{
      const rows = [];
      gradingTbody.querySelectorAll('tr').forEach(r=>{
        const country = r.querySelector('.delegate-country').textContent;
        const delegateName = r.querySelector('.delegate-name-input').value;
        const data = { country, delegateName };
        r.querySelectorAll('input[type=number]').forEach(i=> data[i.dataset.key]=i.value);
        data.total = r.querySelector('.total').textContent;
        data.award = r.querySelector('.award').textContent;
        rows.push(data);
      });
      const csv = toCsv(rows);
      download('mun_grades.csv', csv);
    });

    function toCsv(rows){
      if(rows.length===0) return '';
      const keys = ['country','delegateName','research','participation','diplomacy','speech','writing','leadership','total','award'];
      const lines = [keys.join(',')];
      rows.forEach(r=>{
        const line = keys.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(',');
        lines.push(line);
      });
      return lines.join('\n');
    }

    function download(filename, text){
      const a = document.createElement('a');
      a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(text);
      a.download = filename;
      a.style.display='none';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Navigation System
    function setupNavigation() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const pageId = tab.getAttribute('data-page');
          
          // Update active tab
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Show active page within committee workspace
          document.querySelectorAll('#committee-workspace .page').forEach(page => {
            page.classList.remove('active');
          });
          document.getElementById(`${pageId}-page`).classList.add('active');
          
          // Render grading table only when navigating to grading page
          if (pageId === 'grading') {
            renderGradingTable();
          }
        });
      });
    }

    // Go to grading page button
    document.getElementById('go-to-grading').addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.nav-tab[data-page="grading"]').classList.add('active');
      
      document.querySelectorAll('#committee-workspace .page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById('grading-page').classList.add('active');
      renderGradingTable();
    });

    // Dark Mode Toggle
    const themeToggle = el('theme-toggle');
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        themeToggle.textContent = 'üåô Dark Mode';
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.textContent = '‚òÄÔ∏è Light Mode';
        localStorage.setItem('theme', 'dark');
      }
    });

    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeToggle.textContent = '‚òÄÔ∏è Light Mode';
    }

    // Save / Load
    el('save-all').onclick=()=>{
      saveToFirestore();
      alert('Saved to cloud');
    }
    el('load-all').onclick=()=>{
      loadCommitteeData();
      renderAll();
      renderSpeakersHistory();
      alert('Loaded from cloud');
    }
    
    function renderAll(){
      renderRoll();
      renderSpeakers();
      renderMotions();
      renderTimer();
    }

    // Auto-save settings changes
    el('chair-name').addEventListener('input', () => {
      const state = getCurrentCommitteeData();
      if (state) {
        state.settings.chairName = el('chair-name').value;
        saveToFirestore();
      }
    });
    
    el('conf-name').addEventListener('input', () => {
      const state = getCurrentCommitteeData();
      if (state) {
        state.settings.conference = el('conf-name').value;
        saveToFirestore();
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupNavigation();
      
      // Set up speakers history event listeners
      document.getElementById('add-to-history').addEventListener('click', addCurrentSpeakerToHistory);
      document.getElementById('clear-history').addEventListener('click', clearSpeakersHistory);
      document.getElementById('export-speakers-csv').addEventListener('click', exportSpeakersHistoryToCSV);
    });
  </script>
</body>
</html>

